# 帮助:编写扩展

<!-- source html: G:\repos\THBWiki-Markdown-Builder\THBWikiMarkdown\Temp\other\a\ac\ns12%3A%E7%BC%96%E5%86%99%E6%89%A9%E5%B1%95.html -->

帮助文档 | 扩展帮助文档

本页是THBWiki的[编辑帮助文档](./分类-帮助文档.md)

<table><tbody><tr><td><table cellspacing="0" class="nowraplinks mw-collapsible uncollapsed" style="width:100%;;;"><tbody><tr><th style=";" colspan="3" class="navbox-title"><div class="navbar"><div class="noprint plainlinksneverexpand" style="background-color:transparent; padding:0; font-weight:normal; font-size:80%; white-space:nowrap;"><a href="./模板-帮助页面导航.md" title="模板:帮助页面导航"><span style=";;border:none;" title="查看这个模板">查</span></a>&#160;<span style="font-size:80%;">•</span>&#160;<a href="/index.php?title=%E6%A8%A1%E6%9D%BF:%E5%B8%AE%E5%8A%A9%E9%A1%B5%E9%9D%A2%E5%AF%BC%E8%88%AA&amp;action=edit"><span style=";;border:none;" title="您可以编辑这个模板。请在储存变更之前先预览">编</span></a></div></div><span><a href="./分类-帮助文档.md" title="分类:帮助文档">帮助页面导航</a></span></th></tr><tr><td></td></tr><tr><td class="navbox-group" style=";;"><a href="./分类-规范文档.md" title="分类:规范文档">编辑规范</a></td><td style=";;" class="navbox-list navbox-odd"><div><a href="./THBWiki-收录方针.md" title="THBWiki:收录方针">THBWiki收录方针</a> &#8226; <a href="./帮助-词条命名规范.md" title="帮助:词条命名规范">词条命名规范</a> &#8226; <a href="./帮助-词条编写规范.md" title="帮助:词条编写规范">词条编写规范</a> &#8226; <a href="./帮助-符卡截图规范.md" title="帮助:符卡截图规范">符卡截图规范</a> &#8226; <a href="./帮助-同人社团.md" title="帮助:同人社团">同人社团编写规范</a> &#8226; <a href="./帮助-封面图片.md" title="帮助:封面图片">封面图片规范</a> &#8226; <a href="./帮助-同人专辑.md" title="帮助:同人专辑">同人专辑编写规范</a> &#8226; <a href="/index.php?title=%E5%B8%AE%E5%8A%A9:%E5%90%8C%E4%BA%BA%E5%BF%97&amp;action=edit&amp;redlink=1" class="new" title="帮助:同人志（页面不存在）">同人志编写规范</a> &#8226; <a href="/index.php?title=%E5%B8%AE%E5%8A%A9:%E5%90%8C%E4%BA%BA%E8%BD%AF%E4%BB%B6&amp;action=edit&amp;redlink=1" class="new" title="帮助:同人软件（页面不存在）">同人软件编写规范</a> &#8226; <a href="./帮助-活动.md" title="帮助:活动">活动编写规范</a> &#8226; <a href="./帮助-官方角色二次设定页面.md" title="帮助:官方角色二次设定页面">官方角色二次设定页面编写规范</a> &#8226; <a href="./帮助-官作新作词条.md" title="帮助:官作新作词条">官方新作词条编写规范</a> &#8226; <a href="./帮助-官方漫画文字版.md" title="帮助:官方漫画文字版">官方漫画文字版编写规范</a> &#8226;  <a href="./帮助-歌词.md" title="帮助:歌词">歌词编写规范</a> &#8226;  <a href="./帮助-角色介绍可读化.md" title="帮助:角色介绍可读化">角色介绍可读化编写规范</a> &#8226;  <a href="./帮助-地点词条.md" title="帮助:地点词条">地点词条编写规范</a> &#8226;  <a href="./帮助-种族词条.md" title="帮助:种族词条">种族词条编写规范</a></div></td><td class="navbox-image" style="" rowspan="9"><img src="https://static.thwiki.cc/template/info.png" alt="info.png"></td></tr><tr><td></td></tr><tr><td class="navbox-group" style=";;">基础帮助</td><td style=";;" class="navbox-list navbox-even"><div></div><table cellspacing="0" class="nowraplinks navbox-subgroup" style="width:100%;;;;"><tbody><tr><td class="navbox-group" style=";;"><div>编辑代码</div></td><td style=";;" class="navbox-list navbox-odd"><div><a href="./帮助-常用代码.md" title="帮助:常用代码">常用代码</a> &#8226; <a href="./帮助-常用模板.md" title="帮助:常用模板">常用模板</a> &#8226; <a href="./帮助-特殊代码.md" title="帮助:特殊代码">进阶代码</a> &#8226; <a href="./帮助-插入视频.md" title="帮助:插入视频">插入视频</a></div></td></tr><tr><td></td></tr><tr><td class="navbox-group" style=";;"><div>功能性</div></td><td style=";;" class="navbox-list navbox-even"><div><a href="./帮助-强刷新.md" title="帮助:强刷新">强刷新</a> &#8226; <a href="./帮助-颜色表.md" title="帮助:颜色表">颜色表</a> &#8226; <a href="./帮助-跨站链接前缀.md" title="帮助:跨站链接前缀">跨站链接前缀</a> &#8226; <a href="./帮助-样式类别.md" title="帮助:样式类别">样式类用法</a></div></td></tr><tr><td></td></tr><tr><td class="navbox-group" style=";;"><div><a href="./分类-标准名称模板.md" title="分类:标准名称模板">标准名称模板</a></div></td><td style=";;" class="navbox-list navbox-odd"><div><a href="./帮助-角色名模板.md" title="帮助:角色名模板">角色名模板</a> &#8226;<a href="./帮助-音乐名模板.md" title="帮助:音乐名模板">音乐名模板</a>（<a href="./音乐名模板目录.md" title="音乐名模板目录">模板目录</a>） &#8226; <a href="./帮助-称号模板.md" title="帮助:称号模板">称号模板</a>（<a href="./称号模板目录.md" title="称号模板目录">模板目录</a>） &#8226; <a href="./帮助-符卡名模板.md" title="帮助:符卡名模板">符卡名模板</a>（<a href="./符卡名模板目录.md" title="符卡名模板目录">模板目录</a>/<a href="./符卡名模板目录1.md" title="符卡名模板目录1">1</a>/<a href="./符卡名模板目录2.md" title="符卡名模板目录2">2</a>/<a href="./符卡名模板目录3.md" title="符卡名模板目录3">3</a>）  &#8226; <a href="./帮助-能力模板.md" title="帮助:能力模板">能力模板</a>（<a href="./能力模板目录.md" title="能力模板目录">模板目录</a>）&#8226; <a href="./帮助-活动名模板.md" title="帮助:活动名模板">活动名模板</a>（<a href="./活动名模板目录.md" title="活动名模板目录">模板目录</a>/<a href="./活动名模板目录-主要展会.md" title="活动名模板目录/主要展会">主要</a>/<a href="./活动名模板目录-东方Only-东日本地区1限定.md" title="活动名模板目录/东方Only/东日本地区1限定">东日本1</a>/<a href="./活动名模板目录-东方Only-东日本地区限定（关东地方）.md" title="活动名模板目录/东方Only/东日本地区限定（关东地方）">东日本（关东）</a>/<a href="./活动名模板目录-东方Only-东日本地区限定（关东地方2）.md" title="活动名模板目录/东方Only/东日本地区限定（关东地方2）">东日本（关东2）</a>/<a href="./活动名模板目录-东方Only-东日本地区限定（中部地方）.md" title="活动名模板目录/东方Only/东日本地区限定（中部地方）">东日本（中部）</a>/<a href="./活动名模板目录-东方Only-西日本地区限定.md" title="活动名模板目录/东方Only/西日本地区限定">西日本</a>/<a href="./活动名模板目录-东方Only-多地方地区限定.md" title="活动名模板目录/东方Only/多地方地区限定">多地区</a>/<a href="./活动名模板目录-东方Only-作品限定.md" title="活动名模板目录/东方Only/作品限定">作品</a>/<a href="./活动名模板目录-东方Only-角色限定.md" title="活动名模板目录/东方Only/角色限定">角色</a>/<a href="./活动名模板目录-非东方Only.md" title="活动名模板目录/非东方Only">非东方</a>/<a href="./活动名模板目录-中国展会.md" title="活动名模板目录/中国展会">中国</a>/<a href="./活动名模板目录-中国展会2.md" title="活动名模板目录/中国展会2">中国2</a>/<a href="./活动名模板目录-其他地区展会.md" title="活动名模板目录/其他地区展会">其他地区</a>/<a href="./活动名模板目录-未分类.md" title="活动名模板目录/未分类">未分类</a>）</div></td></tr></tbody></table><div></div></td></tr><tr><td></td></tr><tr><td class="navbox-group" style=";;"><a href="./分类-扩展帮助文档.md" title="分类:扩展帮助文档">扩展功能</a></td><td style=";;" class="navbox-list navbox-odd"><div></div><table cellspacing="0" class="nowraplinks navbox-subgroup" style="width:100%;;;;"><tbody><tr><td class="navbox-group" style=";;"><div>简单功能文档</div></td><td style=";;" class="navbox-list navbox-odd"><div><a href="./帮助-翻译表.md" title="帮助:翻译表">翻译表</a> &#8226; <a href="./帮助-固定标题扩展.md" title="帮助:固定标题扩展">固定标题扩展</a> &#8226; <a href="./帮助-时长扩展.md" title="帮助:时长扩展">时长扩展</a> &#8226; <a href="./帮助-汉字数字扩展.md" title="帮助:汉字数字扩展">汉字数字扩展</a> &#8226; <a href="./帮助-货币扩展.md" title="帮助:货币扩展">货币扩展</a> &#8226; <a href="./帮助-转置扩展.md" title="帮助:转置扩展">转置扩展</a></div></td></tr><tr><td></td></tr><tr><td class="navbox-group" style=";;"><div>复杂功能文档</div></td><td style=";;" class="navbox-list navbox-even"><div><a href="./帮助-解析函数.md" title="帮助:解析函数">解析函数</a> &#8226; <a href="./帮助-SMW.md" title="帮助:SMW">语义维基（SMW）</a> &#8226; <a href="./帮助-管理映射方案.md" title="帮助:管理映射方案">管理映射方案</a> &#8226; <a href="./帮助-管理碰撞.md" title="帮助:管理碰撞">管理碰撞</a> &#8226; <a class="mw-selflink selflink">编写扩展</a> &#8226; <a href="./帮助-音乐资料API.md" title="帮助:音乐资料API">音乐资料API</a></div></td></tr></tbody></table><div></div></td></tr><tr><td></td></tr><tr><td class="navbox-group" style=";;">辅助工具</td><td style=";;" class="navbox-list navbox-even"><div><span class="plainlinks"><a rel="nofollow" class="external text" href="https://tool.thwiki.cc/textcolor">渐变色文字生成</a> &#8226; <a rel="nofollow" class="external text" href="https://tool.thwiki.cc/calline">图片边长计算</a> &#8226; <a rel="nofollow" class="external text" href="https://tool.thwiki.cc/sort">模板列表排序</a> &#8226; <a rel="nofollow" class="external text" href="https://tool.thwiki.cc/tracks">曲目时长填写工具</a> &#8226; <a rel="nofollow" class="external text" href="https://tool.thwiki.cc/tags/">用音频文件编写词条</a> &#8226; <a rel="nofollow" class="external text" href="https://tool.thwiki.cc/circlelyrics">社团歌词进度</a> &#8226; <a rel="nofollow" class="external text" href="https://tool.thwiki.cc/lrctowiki">歌词文本转换</a></span> &#8226; <a href="./帮助-Gadget-HotCat.md" title="帮助:Gadget-HotCat">HotCat小工具</a></div></td></tr><tr><td></td></tr><tr><td class="navbox-group" style=";;">测试沙盒</td><td style=";;" class="navbox-list navbox-odd"><div><a href="/%E6%B2%99%E7%9B%92" title="沙盒">沙盒</a> &#8226; <a href="./沙盒-高级功能.md" title="沙盒/高级功能">进阶沙盒</a> &#8226; <a href="./模板-沙盒.md" title="模板:沙盒">模板沙盒‎</a> &#8226; <a href="./沙盒-SMW.md" title="沙盒/SMW">SMW‎沙盒‎</a> &#8226; <a href="./沙盒-乐谱.md" title="沙盒/乐谱">乐谱沙盒‎</a> &#8226; <a href="./帮助-皮肤.md" title="帮助:皮肤">皮肤‎‎</a></div></td></tr></tbody></table></td></tr></tbody></table>


  
本页面用于记录部分编写扩展时会用到的功能接口、需要注意的事项，扩展的修改记录可以参看[帮助:扩展修改记录](./帮助-扩展修改记录.md)。
  

## 目录

- [1 理论](#理论)

  - [1.1 缓存机制](#缓存机制)



- [2 功能接口实作](#功能接口实作)

  - [2.1 全域函数](#全域函数)

    - [2.1.1 wfMessage](#wfMessage)
    - [2.1.2 wfEscapeWikiText](#wfEscapeWikiText)
    - [2.1.3 wfSetVar](#wfSetVar)
    - [2.1.4 wfSuppressWarnings](#wfSuppressWarnings)
    - [2.1.5 wfGetDB](#wfGetDB)
    - [2.1.6 ](#)



  - [2.2 类](#类)

    - [2.2.1 Title](#Title)
    - [2.2.2 Message](#Message)



  - [2.3 全域变量](#全域变量)

    - [2.3.1 wgExtensionCredits](#wgExtensionCredits)
    - [2.3.2 wgAutoloadClasses](#wgAutoloadClasses)
    - [2.3.3 wgMessagesDirs](#wgMessagesDirs)
    - [2.3.4 wgExtensionMessagesFiles](#wgExtensionMessagesFiles)
    - [2.3.5 wgSpecialPages](#wgSpecialPages)
    - [2.3.6 wgSpecialPageGroups](#wgSpecialPageGroups)
    - [2.3.7 wgJobClasses](#wgJobClasses)
    - [2.3.8 wgAPIModules](#wgAPIModules)
    - [2.3.9 wgResourceModules](#wgResourceModules)
    - [2.3.10 ](#_2)



  - [2.4 Hook](#Hook)

    - [2.4.1 GetPreferences](#GetPreferences)
    - [2.4.2 AdminLinks](#AdminLinks)
    - [2.4.3 OutputPageParserOutput](#OutputPageParserOutput)
    - [2.4.4 BeforePageDisplay](#BeforePageDisplay)
    - [2.4.5 SkinTemplateNavigation](#SkinTemplateNavigation)
    - [2.4.6 ParserFirstCallInit](#ParserFirstCallInit)
    - [2.4.7 MagicWordwgVariableIDs](#MagicWordwgVariableIDs)
    - [2.4.8 ParserGetVariableValueSwitch](#ParserGetVariableValueSwitch)
    - [2.4.9 ParserLimitReport](#ParserLimitReport)
    - [2.4.10 ](#_3)










## 理论
### 缓存机制
  
根据我的观测和猜测，MW的缓存机制很复杂，光是我能明显区分的层次就有4个，可能还有更多的层次实现着各种各样奇葩的功能。
  

-  **源代码** ，就是WikiCode，最原始的状态，在任何一个词条按右上的“编辑”就能浏览得到。
-  **一级缓存** ，此层次只会在词条本身有改动或嵌入的模板有改动的时候刷新，虽然不清楚具体储存了什么，但如果不刷新此层次有部分应该已经改变了的东西仍然会停留在旧的状态。
-  **二级缓存** ，储存和特殊:展开模板 (未找到链接)差不多的文字，所有可以展开的都展开了，只剩少量MW基本语法（比如[[]] == == * #&#160;:），可以通过action=purge刷新。如果没有打开FileCache，或者是不能使用FileCache的情况，一般页面会从这个缓存开始，通过简单处理、寻找链接判断红蓝，整理出HTML显示。
-  **FileCache** ，为非登录用户储存整理后的纯HTML，侧边栏，顶部底部都会被缓存，极节省时间。

## 功能接口实作
### 全域函数
#### wfMessage
  
通过Message名称获取[Message](#Message)物件
  

```
wfMessage( &#39;xxx-msg&#39; );
```

#### wfEscapeWikiText
  
转义所有特殊字符，用以在HTML中显示，是强化版的htmlspecialchars
  

```
wfEscapeWikiText( $text );
```

  
最最最最大的问题是他没有反函数，所以在很多情况下都带来很多麻烦。
  

#### wfSetVar
  
特殊的设变量方法，会把$variable的值换成$value，然后传回$variable原本的值，当$force是true的时候即使$value是null也会强制设定$variable
  

```
wfSetVar( $variable, $value );
wfSetVar( $variable, $value, $force );
```

#### wfSuppressWarnings
  
强制禁止输出警告，用true来复原
  

```
wfSuppressWarnings();
wfSuppressWarnings(true);
```

#### wfGetDB
  
获取[DatabaseBase](#DatabaseBase)物件
  

```
wfGetDB(DB_MASTER);
wfGetDB(DB_SLAVE);
```

  
DB_MASTER用于写，DB_SLAVE用于读。
  

#### 

### 类
#### Title
- Title::newFromDBkey，用DBkey来生产Title，DBkey就是把空格转为_，包含命名空间的页面标题。

```
$title = Title::newFromDBkey( $key );
```

- Title::newFromText，用纯文字来生产Title，是最常用的一个，还可以强制设定命名空间。

```
$title = Title::newFromText( $text, NS_MAIN );
```

- Title::newFromID，用页面ID来生产Title，是最准确的一个，而且在提交表格时比起传送标题文字，传送数字更简单。

```
$title = Title::newFromID( $id );
```

- Title::newFromIDs，用多个页面ID来生产多个Title，输入输出都是array。

- Title::newFromRow，用sql结果行来生产Title，有时候需要做query，顺便连结获取结果词条的所有资料，就省下再用newFromID获取Title资料的功夫了，不过获取的资料不能有缺漏。需要的列有：page_namespace、page_title、page_id、page_len、page_is_redirect、和page_latest，page_lang和page_content_model可有可无。

```
$title = Title::newFromRow( $row );
```

- Title::makeTitle，最一般的方法，页面名称和命名空间分开两个参数传入，可以更严格地限制Title的命名空间。

```
$title = Title::makeTitle( $ns, $title, $fragment, $interwiki );
```

- Title::makeTitleSafe，和Title::makeTitle差不多，只不过强化了安全性，适合对用户输入操作。

```
$title = Title::makeTitleSafe( $ns, $title, $fragment, $interwiki );
```

- Title::newMainPage，获取主页的Title，一般没什么用。

- Title::compare，比较两个Title，用于usort排序Title。

```
Title::compare( $a, $b );
```

- getText，获取标题文字，用空格，无命名空间
- getPartialURL，获取URL编码后的标题，无命名空间
- getDBkey，获取DBkey，用_，有命名空间
- getNamespace，获取命名空间的数字
- getNsText，获取命名空间的文字
- getSubjectNsText，获取命名空间的文字，如果是讨论页获取讨论内容的命名空间
- getTalkNsText，获取对应讨论页的命名空间
- getPrefixedDBkey，获取标题文字，用_，有命名空间
- getPrefixedText，获取标题文字，用空格，有命名空间
- getFullText，获取标题文字，用空格，有命名空间，再加上#和段落
- getRootText，获取根页面标题文字，用空格，无命名空间
- getRootTitle，获取根页面Title
- getBaseText，获取上一级页面标题文字，用空格，无命名空间
- getBaseTitle，获取上一级页面Title
- getSubpageText，获取子页面标题文字，用空格，无命名空间，比如User:Foo/Bar/Baz返回Baz
- getSubpage，获取指定子页面Title

```
Title::newFromText(&#39;User:Foo/Bar/Baz&#39;)-&gt;getSubpage(&quot;Asdf&quot;);
// 返回标题是 User:Foo/Bar/Baz/Asdf 的Title
```

- getPrefixedURL，获取URL编码后的标题，有命名空间
- getFullURL，获取完整网址，可以加上query

```
$title-&gt;getFullURL( $query );
```

- getLocalURL，获取内链网址，不包含域名，可以加上query

```
$title-&gt;getFullURL( $query );
```

- getEditURL，获取编辑页面的链接
- getArticleID，获取页面ID
- getLatestRevID，获取当前版本ID
- isSpecialPage，是否特殊页面
- isMainPage，是否主页
- isSubpage，是否子页面
- isRedirect，是否重定向页
- isNewPage，是否新页面
- exists，页面是否存在

- inNamespace，是否位于此命名空间

```
$title-&gt;inNamespace( $ns );
```

- inNamespace，是否位于其中一个命名空间

```
$title-&gt;inNamespace( $ns1, $ns2, $ns3 );
$title-&gt;inNamespace( array( $ns1, $ns2, $ns3 ) );
```

- getSubpages，获取子页面，返回Title组成的array

```
$title-&gt;getSubpages( $limit );
```

  
可以设定$limit限制最大获取的子页面数，不设定或者设为-1代表不限制。
  

- getParentCategories，获取页面所属的分类，返回分类名是key的array

```
$title-&gt;getParentCategories();
// 会返回 array( &#39;分类:XXX&#39; =&gt; &#39;词条名&#39;, &#39;分类:YYY&#39; =&gt; &#39;词条名&#39;, &#39;分类:ZZZ&#39; =&gt; &#39;词条名&#39; )格式的array，有点坑
```

- getRedirectsHere，获取重定向到此页面的页面，返回Title组成的array

```
$title-&gt;getRedirectsHere( $ns );
```

  
设定$ns可以限制返回的页面的命名空间
  

#### Message
  
用来获取Message的类，Message可以由扩展的i18n json、php及MediaWiki命名空间的词条定义。
  

- exists，辨别该Message是否存在。

- text、plain、escape、parse、parseAsBlock，以各种形式输出Message的内容，实际上都是几下要输出的类型然后丢给__toString的，一般情况什么都不写自动__toString也是不会出问题的。text返回把{{}}都展开了的文字；plain返回源码；escape返回HTML转义了的text；parse返回所有wiki代码都展开了的纯html；parseAsBlock返回带框的parse。

- inLanguage，设定语言

```
wfMessage( &#39;msg-name-xxx&#39; )-&gt;inLanguage( &#39;en&#39; )-&gt;text();
// 把输出的语言转为en
```

- inContentLanguage，设定语言为当前语言，如果没有操作过inLanguage的话这个是完全不会用到的。

```
wfMessage( &#39;msg-name-xxx&#39; )-&gt;inContentLanguage()-&gt;text();
// 把输出的语言转为en
```

- numParams，为Message添加参数，会顺序把Message里面的$1$2$n替换成那些参数。

```
wfMessage( &#39;msg-name-xxx&#39; )-&gt;numParams( &#39;1&#39;, &#39;2&#39; );
// 较常用的比如
wfMessage( &#39;parentheses&#39; )-&gt;numParams( &#39;括号内容&#39; )-&gt;text();
// 会输出：（括号内容） 实际用什么类型的括号受到选用的语言影响，比如en的话就是()
wfMessage( &#39;quotation-marks&#39; )-&gt;numParams( &#39;引号内容&#39; )-&gt;text();
// 会输出：“括号内容” 实际用什么类型的引号受到选用的语言影响，比如en的话就是&quot;&quot;
```

  
其他常用的有：
  

- semicolon-separator，分号（排比分隔符）"；"
- comma-separator，逗号（并列分隔符）"、"
- colon-separator，冒号"："
- pipe-separator，竖杠"&#32;|&#32;"
- word-separator，字词分隔符（中文里并没有）""
- parentheses，括号"（$1）"
- quotation-marks，引号"“$1”"
- imgmultipageprev，上一页"← 上一页"
- imgmultipagenext，下一页"下一页 →"

### 全域变量
##### wgExtensionCredits
  
定义扩展信息列表，用来在特殊:版本信息 (未找到链接)中显示
  

```
define( &#39;XXX_VERSION&#39;, &#39;1.0.0&#39; );
$wgExtensionCredits[&#39;parserhook&#39;][] = array(
	&#39;path&#39; =&gt; __FILE__,
	&#39;name&#39; =&gt; &#39;ExtensionName&#39;,
	&#39;version&#39; =&gt; XXX_VERSION,
	&#39;author&#39; =&gt; array( &#39;XXX&#39; ),
	&#39;url&#39; =&gt; &#39;http://thwiki.cc/&#39;,
	&#39;descriptionmsg&#39; =&gt; &#39;extensionname-desc&#39;,
);
```

  
一般都是parserhook或者other。
  

##### wgAutoloadClasses
  
定义autoload对照表，简单地
  

```
$wgAutoloadClasses[&#39;ClassNameXXX&#39;] = __DIR__ . &#39;/ClassNameXXX.php&#39;;
```

  
就行了，用autoload而不是require或include能节省很多服务器资源。
  

##### wgMessagesDirs
  
定义扩展Messages所在的文件夹，对于所有扩展都是一个写法，适用使用i18n json的情况
  

```
$wgMessagesDirs[&#39;ExtensionNameXXX&#39;] = __DIR__ . &#39;/i18n&#39;;
```

  
自MW1.21起扩展所有Messages都应该写在i18n json里。
  

##### wgExtensionMessagesFiles
  
然而wgMessagesDirs只能定义Message，不能用来定义magic和alias，所以还需要用这个定义扩展magic和alias所在的文件
  

```
$wgExtensionMessagesFiles[&#39;ExtensionNameXXXMagic&#39;] = __DIR__ . &#39;/ExtensionNameXXX.magic.php&#39;;
```

##### wgSpecialPages
  
定义特殊页面列表及定义特殊页面所用的类，需要增加特殊页面的时候需要
  

```
$wgSpecialPages[&#39;SpecialPageNameXXX&#39;] = &#39;SpecialPageClassNameXXX&#39;;
```

  
同时也需要加到autoload里面。
  

##### wgSpecialPageGroups
  
定义各个特殊页面的分组
  

```
$wgSpecialPageGroups[&#39;SpecialPageNameXXX&#39;] = &#39;pagetools&#39;;
```

  
差不多都是pagetools或parserhook。
  

##### wgJobClasses
  
定义Job列表及定义Job所用的类
  

```
$wgJobClasses[&#39;JobNameXXX&#39;] = &#39;JobClassNameXXX&#39;;
```

  
同时也需要加到autoload里面。
  

##### wgAPIModules
  
定义api模组列表及定义api模组所用的类
  

```
$wgAPIModules[&#39;APIModulesNameXXX&#39;] = &#39;APIModulesClassNameXXX&#39;;
```

  
当链接到api.php?action=APIModulesNameXXX的时候就会调用APIModulesClassNameXXX处理请求。
  

##### wgResourceModules
  
定义js/css模组列表
  

```
$wgResourceModules[&#39;ext.ModulesXXX&#39;] = array(
	&#39;localBasePath&#39; =&gt; __DIR__,
	&#39;remoteExtPath&#39; =&gt; &#39;ExtensionNameXXX&#39;,
	&#39;scripts&#39; =&gt; array( &#39;ExtensionNameXXX.js&#39; ),
	&#39;styles&#39; =&gt; array( &#39;ExtensionNameXXX.css&#39; ),
);
```

  
其他还可以定义messages，一个包含着模组需要用到的Message的名称的array，在js里可以用
  

```
mw.message( &#39;MessageNameXXX&#39; ).plain();
mw.message.apply( &#39;MessageNameXXX&#39;, [&#39;aaa&#39;,&#39;bbb&#39;] ).plain();
```

  
简单地调用在服务器端里定义了的Message。  

以及dependency，一个包含着模组需要用到的模组的名称的array，系统会确保在dependency都加载好了的时候才加载你的模组。
  

##### 

### Hook
##### GetPreferences
  
当用户进入到特殊:参数设置 (未找到链接)时会就调用，用来增加可以设定的项目。
  

```
function onGetPreferences ( User $user, array &amp;$preferences ) {
	$preferences[&#39;prefs-name-xxx&#39;] = array(
		&#39;type&#39; =&gt; &#39;toggle&#39;,
		&#39;label-message&#39; =&gt; &#39;prefs-name-xxx-msg&#39;,
		&#39;section&#39; =&gt; &#39;editing/advancedediting&#39;,
	);
	return true;
}
```

  
可以通过[$user](#User)获取个别用户的详细资讯，不过多数用不着。  

$preferences是一个定义了一大堆设定项的阵列，prefs-name-xxx就是把此设定储存到数据库时使用的key，必须确保不会重复。
  

##### AdminLinks
  
AdminLinks用的Hook，用来增加管理员链接页面的内容
  

```
function onAdminLinks ( &amp;$tree ) {
	$section = $tree-&gt;getSection( wfMessage( &#39;adminlinks_general&#39; )-&gt;text() );
	if ( is_null( $section ) ) return true;
	$row = $section-&gt;getRow( &#39;main&#39; );
	$row-&gt;addItem( ALItem::newFromExternalLink( &#39;http://thwiki.cc/&#39;, &#39;首页&#39; ) );
	return true;
}
```

##### OutputPageParserOutput
  
在一级缓存之后，二级缓存之前，要对页面内容作出更改时用的
  

```
function onOutputPageParserOutput ( OutputPage &amp;$page, ParserOutput $output ) {
	$id = $page-&gt;getTitle()-&gt;getArticleID();
	$output-&gt;setText( &#39;&lt;div&gt;ID of this page is &#39; . $id . &#39;&lt;/div&gt;&#39; . $output-&gt;getText() );
	return true;
}
```

  
[$output](#ParserOutput)不是传参考的所以改了也没用，不过即使只有[$page](#OutputPage)也能做足够多的操作了。
  

##### BeforePageDisplay
  
在二级缓存之后，filecache之前，要对页面内容作出更改时用的，多数用于增加js
  

```
function onBeforePageDisplay ( OutputPage &amp;$out, Skin &amp;$sk ) {
	$out-&gt;setPageTitle( &#39;XXX&#39; );
	$out-&gt;addModules( &#39;ext.ModulesXXX&#39; );
	return true;
}
```

  
[$out](#OutputPage)可以做很多种操作，就是不能简单地更改页面内容。
  

##### SkinTemplateNavigation
  
用于在页面顶部导航栏（阅读 编辑 查看历史）内增加内容。
  

```
function onSkinTemplateNavigation ( SkinTemplate &amp;$sktemplate, array &amp;$links ) {
	$links[&#39;views&#39;][&#39;actionnamexxx&#39;] = array(
		&#39;class&#39; =&gt; false,
		&#39;text&#39; =&gt; wfMessage( &#39;actionnamexxx-msg&#39; )-&gt;text(),
		&#39;href&#39; =&gt; $sktemplate-&gt;getTitle()-&gt;getLocalURL( array( &#39;action&#39; =&gt; &#39;edit&#39;, &#39;actionnamexxx&#39; =&gt; &#39;1&#39; ) )
	);
	return true;
}
```

  
class设为false或是空字串的话该导航项就会在页面过窄的时候自动隐藏，节省空间。设为selected的话就会变成当前显示的那项，不过也需要手动把原本显示的项设为空。
  

##### ParserFirstCallInit
  
写ParserHook最重要的一个函数，[Parser](#Parser)初始化的时候会调用一次，用来定义各种ParserHook。
  

```
class ExtMultiArrayMap {
	public static function Init( Parser &amp;$parser ) {
		$parser-&gt;setFunctionHook( &#39;multimap&#39;, &#39;ExtMultiArrayMap::Map&#39;, SFH_OBJECT_ARGS );
		$parser-&gt;setFunctionHook( &#39;multitemplate&#39;, &#39;ExtMultiArrayMap::Template&#39; );
		$parser-&gt;setFunctionHook( &#39;countmap&#39;, &#39;ExtMultiArrayMap::Count&#39;, SFH_OBJECT_ARGS );
		$parser-&gt;setFunctionHook( &#39;counttemplate&#39;, &#39;ExtMultiArrayMap::CountTem&#39; );
		return true;
	}
}
```

  
定义ParserHook的同时，该ParserHook必须在magic内有对应的值
  

```
$magicWords[&#39;en&#39;] = array(
	&#39;multimap&#39; =&gt; array( 0, &#39;multimap&#39;, &#39;multiarraymap&#39; ),
	&#39;multitemplate&#39; =&gt; array( 0, &#39;multitem&#39;, &#39;multiarraytemplate&#39;, &#39;multitemplate&#39; ),
	&#39;countmap&#39; =&gt; array( 0, &#39;countmap&#39; ),
	&#39;counttemplate&#39; =&gt; array( 0, &#39;counttem&#39;, &#39;counttemplate&#39; ),
);
```

  
array的第一个值是0则表示调用时不区分大小写，1则是区分大小写。
  

##### MagicWordwgVariableIDs
  
定义魔术字需要用另外一个Hook
  

```
class ExtMultiArrayMap {
	public static function setMagic ( &amp;$list ) {
		$nohash = array(
			&#39;pagename&#39;, &#39;fullpagename&#39;, &#39;rootpagename&#39;, &#39;basepagename&#39;,
			&#39;subpagename&#39;, &#39;talkpagename&#39;, &#39;subjectpagename&#39;
		);
		foreach ( $nohash as $func ) {
			$list[] = $func . &#39;h&#39;;
		}
	}
}
```

  
该魔术字也必须在magic内有对应的值
  

```
$magicWords[&#39;en&#39;] = array(
	&#39;pagenameh&#39; =&gt; array( 0, &#39;PAGENAMEH&#39; ),
	&#39;fullpagenameh&#39; =&gt; array( 0, &#39;FULLPAGENAMEH&#39; ),
	&#39;rootpagenameh&#39; =&gt; array( 0, &#39;ROOTPAGENAMEH&#39; ),
	&#39;basepagenameh&#39; =&gt; array( 0, &#39;BASEPAGENAMEH&#39; ),
	&#39;subpagenameh&#39; =&gt; array( 0, &#39;SUBPAGENAMEH&#39; ),
	&#39;talkpagenameh&#39; =&gt; array( 0, &#39;TALKPAGENAMEH&#39; ),
	&#39;subjectpagenameh&#39; =&gt; array( 0, &#39;SUBJECTPAGENAMEH&#39; ),
);
```

  
array的第一个值是0则表示调用时不区分大小写，1则是区分大小写。
  

##### ParserGetVariableValueSwitch
  
然后再用这个函数返回魔术字对应的值
  

```
class ExtMultiArrayMap {
	public static function getMagic ( &amp;$parser, &amp;$cache, &amp;$index, &amp;$value ) {
		switch( $index ) {
			case &#39;pagenameh&#39;:
				$value = ( $parser-&gt;mTitle-&gt;getText() );
				break;
			case &#39;fullpagenameh&#39;:
				$value = ( $parser-&gt;mTitle-&gt;getPrefixedText() );
				break;
			case &#39;subpagenameh&#39;:
				$value = ( $parser-&gt;mTitle-&gt;getSubpageText() );
				break;
			case &#39;rootpagenameh&#39;:
				$value = ( $parser-&gt;mTitle-&gt;getRootText() );
				break;
			case &#39;basepagenameh&#39;:
				$value = ( $parser-&gt;mTitle-&gt;getBaseText() );
				break;
			case &#39;talkpagenameh&#39;:
				if ( $parser-&gt;mTitle-&gt;canTalk() ) {
					$talkPage = $parser-&gt;mTitle-&gt;getTalkPage();
					$value = ( $talkPage-&gt;getPrefixedText() );
				} else {
					$value = &#39;&#39;;
				}
				break;
			case &#39;subjectpagenameh&#39;:
				$subjPage = $parser-&gt;mTitle-&gt;getSubjectPage();
				$value = ( $subjPage-&gt;getPrefixedText() );
				break;
		}
		return true;
	}
}
```

##### ParserLimitReport
  
用来在ParserLimitReport里增加内容，一般情况下不会太用到，但是在调试时可以当作trace来用
  

```
function onParserLimitReport( $parser, &amp;$report ) {
	global $wfxxxusedcount;
	$report .= &#39;XXX use count: &#39; . $wfxxxusedcount . &quot;\n&quot;;
	return true;
}
```

```
&lt;!-- 
NewPP limit report
CPU time usage: 0.102 seconds
Real time usage: 0.105 seconds
Preprocessor visited node count: 16/1000000
Preprocessor generated node count: 82/1000000
Post‐expand include size: 1504/2097152 bytes
Template argument size: 0/2097152 bytes
Highest expansion depth: 2/40
Expensive parser function count: 0/100
RegexRedirect use time: 0.00149703025818
CollisionManager use time: 4.29153442383E‐5
XXX use count: 0
ExtLoops count: 0/100
ExtRegexFun count: 0
--&gt;
```

##### 





---

此文档由 [THBWiki-Markdown-Builder](https://github.com/Delsin-Yu/THBWiki-Markdown-Builder) 构建。

文档中的所有内容除特殊注明外，均在 [**知识共享(Creative Commons) 署名-非商业性使用-相同方式共享 3.0 协议**](https://creativecommons.org/licenses/by-sa/3.0/deed.zh-hans) 下提供，附加条款亦可能应用。

引用类型与其他类型作品版权归原作者所有，如有作者授权则遵照授权协议使用。

详细请查阅 [THBWiki：免责声明](https://thbwiki.cc/THBWiki:%E5%85%8D%E8%B4%A3%E5%A3%B0%E6%98%8E)。

